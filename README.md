# GALA Demo Package Import (Bazel)

This example demonstrates how to use GALA with Bazel to import external GALA packages.

## Prerequisites

- Bazel 7.0+
- GALA CLI (`gala` binary)

## Quick Start

```bash
# 1. Add GALA dependencies
gala mod add github.com/martianoff/gala_demo_pkg@v0.2.3

# 2. Add Go dependencies (transitive from GALA package)
gala mod add github.com/google/uuid@v1.6.0 --go

# 3. Sync dependencies (generates go.mod and go.sum)
gala mod tidy

# 4. Build and run
bazel run //:demo
```

## Project Structure

```
gala_demo_pkg_import_bazel/
├── main.gala          # GALA source code
├── gala.mod           # GALA dependencies (source of truth)
├── gala.sum           # GALA checksums
├── go.mod             # Auto-generated by gala mod tidy (Go deps only)
├── go.sum             # Auto-generated by gala mod tidy
├── BUILD.bazel        # Build targets
├── MODULE.bazel       # Bzlmod configuration
└── WORKSPACE          # Empty (using Bzlmod)
```

**Key point:** Only maintain `gala.mod` - the `go.mod` and `go.sum` files are auto-generated by `gala mod tidy`.

## Setup

### 1. Configure gala.mod

This is the only dependency file you need to maintain:

```
module github.com/your/project

gala 1.0

require (
    github.com/martianoff/gala_demo_pkg v0.2.3
    github.com/google/uuid v1.6.0 // go
)
```

Mark Go dependencies (transitive deps from GALA packages) with `// go` comment.

### 2. Run gala mod tidy

```bash
gala mod tidy
```

This automatically generates:
- `go.mod` with Go dependencies (for Gazelle)
- `go.sum` with checksums (for Gazelle)

### 3. Configure MODULE.bazel

```python
module(
    name = "your_project",
    version = "0.0.1",
)

# GALA toolchain
bazel_dep(name = "gala")
local_path_override(
    module_name = "gala",
    path = "../gala_simple",
)

# Go rules
bazel_dep(name = "rules_go", version = "0.50.1")
bazel_dep(name = "gazelle", version = "0.39.1")

# Go dependencies (auto-generated by 'gala mod tidy')
go_deps = use_extension("@gazelle//:extensions.bzl", "go_deps")
go_deps.from_file(go_mod = "//:go.mod")
use_repo(go_deps, "com_github_google_uuid")

# GALA dependencies
gala = use_extension("@gala//:extensions.bzl", "gala")
gala.from_file(gala_mod = "//:gala.mod")
use_repo(gala, "com_github_martianoff_gala_demo_pkg")
```

### 4. Configure BUILD.bazel

```python
load("@gala//:gala.bzl", "gala_binary")

gala_binary(
    name = "demo",
    src = "main.gala",
    deps = [
        "@com_github_martianoff_gala_demo_pkg//:demomath",
    ],
)
```

Only declare direct GALA dependencies - transitive Go deps are resolved automatically.

## Workflow

After changing dependencies in `gala.mod`:

```bash
# 1. Sync dependencies
gala mod tidy

# 2. Build
bazel build //:demo

# 3. Run
bazel run //:demo
```

## How It Works

1. **gala.mod** - Single source of truth for all dependencies
2. **gala mod tidy** - Generates go.mod/go.sum from gala.mod (Go deps only)
3. **Gazelle go_deps** - Uses go.mod for Go package resolution
4. **GALA extension** - Uses gala.mod for GALA package resolution
5. **Transitive deps** - Go dependencies of GALA packages are auto-resolved

## Repository Naming

| Module Path | Bazel Repository |
|-------------|------------------|
| `github.com/google/uuid` | `@com_github_google_uuid` (via go_deps) |
| `github.com/martianoff/gala_demo_pkg` | `@com_github_martianoff_gala_demo_pkg` (via gala) |

## Notes

- GALA stdlib (`@gala//std`) is automatically included
- Only maintain `gala.mod` - run `gala mod tidy` after changes
- GALA packages must be cached first: `gala mod add <package>@<version>`
- Commit `go.mod` and `go.sum` to version control (Bazel needs them)
